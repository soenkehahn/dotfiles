#!/usr/bin/env stack
{-
stack runghc
--resolver lts-8.3 --install-ghc
  --package logging-facade
  --package split
  --package shake
  --package safe
  --package MissingH
-}
{-# OPTIONS_GHC -Wall -Werror #-}
{-# LANGUAGE ViewPatterns #-}
{-# LANGUAGE ScopedTypeVariables #-}

import Control.Arrow
import Data.List
import Data.List.Split
import Data.Maybe
import Development.Shake hiding (doesFileExist, getEnv)
import Safe
import System.Directory
import System.Environment
import qualified System.Logging.Facade as Log
import System.FilePath

main :: IO ()
main = do
  homeDir <- getEnv "HOME"
  setCurrentDirectory homeDir
  buildNixExecutables homeDir
  upgradeStack
  installAptPackages
  installCustom

buildNixExecutables :: FilePath -> IO ()
buildNixExecutables homeDir = do
  unit $ cmd
    (Cwd (homeDir </> ".local/shahn_nix_executables"))
    "./build.sh"

upgradeStack :: IO ()
upgradeStack = do
  unit $ cmd "stack upgrade"

installAptPackages :: IO ()
installAptPackages = do
  installedPackages <- getInstalledPackages
  case (packages \\ installedPackages) of
    [] -> return ()
    toBeInstalled -> do
      Log.info ("installing " ++ unwords toBeInstalled)
      unit $ cmd "sudo apt-get install -y" toBeInstalled

packages :: [String]
packages =
  "apt-file" :
  "arandr" :
  "atool" :
  "automake" :
  "beets" :
  "build-essential" :
  "chromium-browser" :
  "cmake" :
  "cups" :
  "deborphan" :
  "dos2unix" :
  "dosbox" :
  "entr" :
  "epiphany-browser" :
  "fatsort" :
  "firefox" :
  "gdebi" :
  "geeqie" :
  "gimp" :
  "gist" :
  "git" :
  "git-cola" :
  "gitg" :
  "gitk" :
  "golang" :
  "gparted" :
  "graphviz" :
  "handbrake" :
  "htop" :
  "i3lock" :
  "inkscape" :
  "inotify-tools" :
  "iotop" :
  "jnettop" :
  "jq" :
  "kcolorchooser" :
  "kde-baseapps-bin" :
  "kig" :
  "kmag" :
  "konsole" :
  "krita" :
  "kruler" :
  "krusader" :
  "libiw-dev" :
  "libtool-bin" :
  "libx11-dev" :
  "libx11-protocol-other-perl" :
  "libx11-windowhierarchy-perl" :
  "libxext-dev" :
  "libxft-dev" :
  "libxinerama-dev" :
  "libxpm-dev" :
  "libxrandr-dev" :
  "libxss-dev" :
  "lxde" :
  "m4" :
  "meld" :
  "mercurial" :
  "mhwaveedit" :
  "mkvtoolnix" :
  "mosh" :
  "mplayer" :
  "nethogs" :
  "net-tools" :
  "numlockx" :
  "okteta" :
  "okular" :
  "openjdk-8-jdk" :
  "openssh-server" :
  "openvpn" :
  "pavucontrol" :
  "php-cli" :
  "pm-utils" :
  "postgresql-client-9.6" :
  "postgresql-client-common" :
  "powertop" :
  "pv" :
  "pwgen" :
  "python-pip" :
  "redshift" :
  "renameutils" :
  "ri-li" :
  "rofi" :
  "rtorrent" :
  "screen" :
  "sgt-puzzles" :
  "sloccount" :
  "smplayer" :
  "sonata" :
  "sox" :
  "sshfs" :
  "stellarium" :
  "tig" :
  "tmux" :
  "tree" :
  "unison-gtk" :
  "upx-ucl" :
  "vagrant" :
  "vim" :
  "virtualbox" :
  "vlc" :
  "wajig" :
  "whois" :
  "xclip" :
  "xloadimage" :
  "xmonad" :
  "xsel" :
  "xtail" :
  "zlib1g-dev" :
  "zsh" :
  []

getInstalledPackages :: IO [String]
getInstalledPackages = do
  Stdout output <- cmd "dpkg -l"
  return $ parse output
  where
    parse =
      lines >>>
      map (stripPrefix "ii  ") >>>
      catMaybes >>> map (splitOneOf " :" >>> headMay) >>> catMaybes

installCustom :: IO ()
installCustom = do
  unit $ cmd (Cwd ".local/custom") "./install.sh"
